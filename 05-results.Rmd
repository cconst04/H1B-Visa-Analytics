# Results
```{r, echo=FALSE}
library(dplyr)
library(mi)
library(ggplot2)
library(naniar)
library(extracat)
library(lubridate)
JOB_CODES <- c('11'='Management', '13'='Financial Operations', '23'='Legal',
               '15'='Computer and Maths', '16'='Architecture and Engineering',
               '17'='Life', '18'='Physical', '19'='Life, Physical, and Social Science',
               '21'='Community and Social Service', '25'='Educational Instruction and Library', 
               '27'='Arts, Design, Entertainment, Sports, and Media', '29'='Healthcare',
               '31'='Healthcare Support', '33'='Protective Service', '35'='Food Preparation and Serving',
               '37'='Building, Cleaning and Maintenance', '39'='Personal Care', '41'='Sales', 
               '43'='Office and Administrative Support', '45'='Farming, Fishing and Forestry',
               '47'='Construction and Extraction Occupations', '49'='Installation, Maintenance and Repair',
               '51'='Production Occupations', '53'='Transportation and Material Moving', '55'='Military'
              )
START_YEAR <- 2009
END_YEAR <- 2020
```
```{r Loading datasets}
test <- read.csv('csv/2010.csv')
test <- test[test$LCA_CASE_EMPLOYER_STATE %in% state.abb, ]
df_ucsis <- data.frame()
for(year in START_YEAR:2020){
  tmp <- read.csv(paste0("ucsis/", year, ".csv"))
  df_ucsis <- rbind(df_ucsis, tmp)
}
df_ucsis[df_ucsis==""] <- NA
count_applications <- list()
#read all years
df <- data.frame()
for(year in START_YEAR:END_YEAR){
  tmp <- read.csv(paste0("csv/processed_", year, ".csv"))
  tmp$year <- year
  df <- rbind(df, tmp)
  count_applications[[year - START_YEAR + 1]] <- nrow(data.frame(tmp))
}
df$FULL_TIME_POSITION.1 <- NULL
df$SOC_CODE <- as.character(df$SOC_CODE)
#remove 0 wage
df <- df[df$annual_wage > 0  && !is.nan(df$annual_wage),]
df_2020 <- data.frame()
for(q in 1:4){
  tmp <- read.csv(paste0("csv/2020_q", q, ".csv"))
  df_2020 <- rbind(df_2020, tmp)
}
df_2020$BEGIN_MONTH <- month(as.Date(df_2020$BEGIN_DATE, format='%m/%d/%y'))
df_2020$BEGIN_MONTH <- sapply(df_2020$BEGIN_MONTH, function(month) month.abb[month])
df_2020$BEGIN_MONTH <- factor(df_2020$BEGIN_MONTH, levels=month.abb, ordered=TRUE)
df_sample <- sample_n(df_2020, size=30)
num_applications <- data.frame(year=START_YEAR:END_YEAR)
num_applications['total_applications'] <- unlist(count_applications)
df_tmp <- df
df_tmp <- df_tmp[!is.na(df_tmp$SOC_CODE), ]
df_tmp <- df_tmp[df_tmp$SOC_CODE %in% names(JOB_CODES),]
counts <- count(df_tmp, year, SOC_CODE)
counts <- transform(counts, SOC_CODE = JOB_CODES[SOC_CODE])
counts <- counts[!is.na(counts$SOC_CODE),]
```
## Inspecting missing values  
We have selected randomly a year and plotted the percentage values missing grouped by state.  
```{r Missing Values}
gg_miss_fct(x = test, fct = LCA_CASE_EMPLOYER_STATE)
```  
- A big percentage of PW_2 and LCA_CASE_WAGE_RATE_TO and YR_SOURCE_PUB_2 independently of the state  
- The employer's postal code (LCA_CASE_EMPLOYER_POSTAL_CODE) is missing depending on the state. Half of the applications from employers from Arkansas are missing their postal code  
  
Combinations of missing values  
```{r Missing values combinations}
visna(test)
```  
- The combination WAGE_RATE_TO, PW_2 and YR_SOURCE_PUB_2 is the most frequent. Each of these columns individually have approximately 80-90% of their values missing    
- Less than 5% of the records are missing the employers postal code  
  
Missing data patterns of the UCSIS final decisions for Visa applications  
```{r}
gg_miss_fct(x = df_ucsis, fct = Fiscal.Year)
```  
There are almost no missing data  
  
## 2020 missing values  
```{r}
gg_miss_fct(df_2020, BEGIN_MONTH) + scale_x_discrete(expand=c(0, 0))
```  
- Between July and September AGENT_ATTORNEY_PHONE_EXT, EMPLOYER_PHONE_EXT and EMPLOYER_POC_PHONE_EXT are missing  
- PW_OTHER_YEAR is completely missing  
  
## Missing values from a sample  
```{r}
image(missing_data.frame(df_sample))
```  

## Number of applications per year  
```{r Applications per year}
ggplot(data=num_applications, aes(x=year, y=total_applications)) +
  geom_line()
```   
There is an upward trend in the number of applications from 2009 to 2020  
  
## Annual salary boxplot    
```{r}
boxplot(annual_wage ~ year, data=df, outline=FALSE)
```  
There is an upward trend in the 25th quartile, median, 75th quartile and maximum salary from 2009 to 2020  

## Applications by subject  
```{r}
ggplot(counts, aes(x=n, y=SOC_CODE)) + geom_col() + facet_wrap(~ year, ncol=2)
```  
Jobs related to computer science and mathematics are the most famous for H-1B applications for every year  
  
```{r, echo=FALSE}
counts <- counts[counts$SOC_CODE != 'Computer and Maths',]
```  
  
## Applications by subject with Computer Science and Maths removed  
```{r}
ggplot(counts, aes(x=n, y=SOC_CODE)) + geom_col() + facet_wrap(~ year, ncol=2) 
```  
Financial operations is the second most famous job for every year
